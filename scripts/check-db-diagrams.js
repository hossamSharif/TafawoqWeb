// Direct database check for diagram data
const { createClient } = require('@supabase/supabase-js');

const supabaseUrl = 'https://fvstedbsjiqvryqpnmzl.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ2c3RlZGJzamlxdnJ5cXBubXpsIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1ODEzNTI3OSwiZXhwIjoyMDczNzExMjc5fQ.KWmtmoPziqWBGMKzknqbA9K6zVnf6J5iQmu8HdbGnHY';

const supabase = createClient(supabaseUrl, supabaseKey);

async function checkDiagrams() {
  console.log('=== CHECKING EXAM DIAGRAMS IN DATABASE ===\n');

  // Get recent exam sessions
  const { data: sessions, error } = await supabase
    .from('exam_sessions')
    .select('id, created_at, questions, status')
    .order('created_at', { ascending: false })
    .limit(5);

  if (error) {
    console.error('Database error:', error);
    return;
  }

  console.log('Found', sessions.length, 'recent exam sessions\n');

  for (const session of sessions) {
    console.log('='.repeat(60));
    console.log('Session:', session.id);
    console.log('Created:', session.created_at);
    console.log('Status:', session.status);

    const questions = session.questions || [];
    console.log('Total questions:', questions.length);

    // Find geometry/diagram questions
    const diagramQuestions = questions.filter(q =>
      q.questionType === 'diagram' ||
      q.topic === 'geometry' ||
      q.question_type === 'diagram'
    );

    console.log('Geometry/Diagram questions:', diagramQuestions.length);

    if (diagramQuestions.length > 0) {
      console.log('\nDiagram question details:');
      diagramQuestions.forEach((q, i) => {
        console.log(`\n  Q${q.index !== undefined ? q.index + 1 : i + 1}:`);
        console.log('    questionType:', q.questionType || q.question_type);
        console.log('    topic:', q.topic);
        console.log('    HAS diagram field:', q.diagram ? 'YES' : 'NO');
        console.log('    HAS diagram_config field:', q.diagram_config ? 'YES' : 'NO');

        if (q.diagram) {
          console.log('    diagram.type:', q.diagram.type);
          console.log('    diagram.renderHint:', q.diagram.renderHint);
          console.log('    diagram.data:', JSON.stringify(q.diagram.data || {}).slice(0, 100) + '...');
        }
        if (q.diagram_config) {
          console.log('    diagram_config.type:', q.diagram_config.type);
          console.log('    diagram_config.renderHint:', q.diagram_config.renderHint);
        }
      });
    }
    console.log('');
  }

  // Summary
  console.log('\n' + '='.repeat(60));
  console.log('SUMMARY');
  console.log('='.repeat(60));

  let totalDiagramQs = 0;
  let withDiagram = 0;
  let withDiagramConfig = 0;

  for (const session of sessions) {
    const questions = session.questions || [];
    const diagramQs = questions.filter(q =>
      q.questionType === 'diagram' || q.topic === 'geometry'
    );
    totalDiagramQs += diagramQs.length;
    withDiagram += diagramQs.filter(q => q.diagram).length;
    withDiagramConfig += diagramQs.filter(q => q.diagram_config).length;
  }

  console.log('Total diagram/geometry questions across all exams:', totalDiagramQs);
  console.log('Questions with "diagram" field:', withDiagram);
  console.log('Questions with "diagram_config" field:', withDiagramConfig);

  if (withDiagram === 0 && withDiagramConfig === 0) {
    console.log('\n⚠️  WARNING: No diagram data found in any exam!');
    console.log('This confirms diagrams are NOT being generated by Claude.');
  }
}

checkDiagrams().catch(console.error);
